/**
* The MIT License (MIT)
*
* Copyright (c) 2014 Sebastian Nette
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
*
* 
*
*/

/**
 * PIXI Draggables & Droppables v1.0.0
 * Copyright (c) 2014, Sebastian Nette
 * http://www.mokgames.com/
 */

PIXI.DisplayObject.prototype.draggable=function(t,e){if(void 0==e&&null===t)this.__draggable=!1,this.mousedown=this.touchstart=n.mousedown,this.mousemove=this.touchmove=n.mousemove,this.mouseup=this.touchend=n.mouseup,this.mouseupoutside=this.touchendoutside=n.mouseupoutside,this.interactive=!0
else if(void 0===e){this.__draggable&&this.draggable(null)
var n=t||{}
for(var a in PIXI.DragAndDropManager.options.drag)n.hasOwnProperty(a)||(n[a]=PIXI.DragAndDropManager.options.drag[a])
this.mousedown&&!n.mousedown&&(n.mousedown=this.mousedown),this.mousemove&&!n.mousemove&&(n.mousemove=this.mousemove),this.mouseup&&!n.mouseup&&(n.mouseup=this.mouseup),this.mouseupoutside&&!n.mouseupoutside&&(n.mouseupoutside=this.mouseupoutside),this.dragOptions=n,this.offset=new PIXI.Point(0,0),this.original=new PIXI.Point(0,0),n.snap&&(this.snapElements=[]),this.interactive=!0,this.__draggable=!0,this.mousedown=this.touchstart=PIXI.DragAndDropManager.onMouseDown.bind(this),this.mousemove=this.touchmove=PIXI.DragAndDropManager.onMouseMove.bind(this),this.mouseup=this.touchend=PIXI.DragAndDropManager.onMouseUp.bind(this),this.mouseupoutside=this.touchendoutside=PIXI.DragAndDropManager.onMouseUpOutside.bind(this)}else this.dragOptions&&(this.__draggable||this.draggable(),this.dragOptions[t]=e,"snap"===t&&e&&(this.snapElements=[]))
return this},PIXI.DisplayObject.prototype.droppable=function(t,e){if(void 0==e&&null===t)this.__droppable=!1,this.interactive=!0
else if(void 0===e){var n=t||{}
for(var a in PIXI.DragAndDropManager.options.drop)n.hasOwnProperty(a)||(n[a]=PIXI.DragAndDropManager.options.drop[a])
this.dropOptions=n,this.interactive=!0,this.__droppable=!0}else this.dropOptions&&(this.__droppable||this.droppable(),this.dropOptions[t]=e)
return this},PIXI.DragAndDropManager=function(){this.draggableItems=[],this.droppableItems=[],this.tweeningItems=[],this.boundTick=this.tick.bind(this),this.isTicking=!1},PIXI.DragAndDropManager.prototype.constructor=PIXI.DragAndDropManager,PIXI.DragAndDropManager.prototype.clear=function(){this.draggableItems.length=0,this.droppableItems.length=0},PIXI.DragAndDropManager.prototype.collect=function(t){t.__draggable&&this.draggableItems.push(t),t.__droppable&&this.droppableItems.push(t)},PIXI.DragAndDropManager.prototype.onDrag=function(t,e){var n=t.dragOptions
if(t.tweening||n.disabled)return void(t.__isDragging=!1)
var a,r
if(n.handle)if("string"==typeof n.handle){var i=!1
for(a=t.children.length-1;a>=0;a--)if(r=t.children[a],(r.label===n.handle||r.__draggable&&r.dragOptions.label===n.handle||r.__droppable&&r.dropOptions.label===n.handle)&&t.stage.interactionManager.hitTest(r,e)){i=!0
break}if(!i)return void(t.__isDragging=!1)}else if(!t.stage.interactionManager.hitTest(n.handle,e))return void(t.__isDragging=!1)
if(n.cancel)if("string"==typeof n.cancel){for(a=t.children.length-1;a>=0;a--)if(r=t.children[a],(r.label===n.cancel||r.__draggable&&r.dragOptions.label===n.cancel||r.__droppable&&r.dropOptions.label===n.cancel)&&t.stage.interactionManager.hitTest(r,e))return void(t.__isDragging=!1)}else if(t.stage.interactionManager.hitTest(n.cancel,e))return void(t.__isDragging=!1)
if(n.cursorAt){var o=e.getLocalPosition(t)
t.offset.set(n.cursorAt[0]-o.x,n.cursorAt[1]-o.y)}else t.offset.set(0,0)
t.original.x=t.x,t.original.y=t.y,e.start?(e.start.x=e.global.x,e.start.y=e.global.y):e.start=e.global.clone(),t.originalAlpha=t.alpha},PIXI.DragAndDropManager.prototype.onDragStart=function(t,e){var n=t.dragOptions
if(Math.abs(e.start.x-e.global.x)<n.distance&&Math.abs(e.start.y-e.global.y)<n.distance)return void(t.__dragStart=!1)
if(this.destroyHelperSprite(t),"clone"===n.helper?(t.dragElement=new PIXI.Sprite(t.generateTexture()),t.parent.addChild(t.dragElement),t.dragElement.position.set(t.x,t.y),t.dragElement.pivot.set(t.pivot.x,t.pivot.y),t.anchor&&t.dragElement.anchor.set(t.anchor.x,t.anchor.y),"inherit"!==n.cursor&&(t.dragElement.interactive=!0)):t.dragElement=t,t.dragElement._defaultCursor=t.dragElement.defaultCursor,t.dragElement.defaultCursor=n.cursor,t.dragElement._buttonMode=t.dragElement.buttonMode,t.dragElement.buttonMode=!0,t.dragElement.alpha=t.alpha*n.alpha,n.snap)for(var a,r,i=this.draggableItems,o=i.length-1;o>=0;o--)a=i[o],!a.worldVisible||n.snap!==!0&&n.snap!==a.dragOptions.label||a===t||(r=a.hitArea?a.hitArea:a.getBounds(),a.snapBounds?(a.snapBounds.x=r.x,a.snapBounds.y=r.y,a.snapBounds.x2=r.x+r.width,a.snapBounds.y2=r.y+r.height):a.snapBounds={x:r.x,y:r.y,x2:r.x+r.width,y2:r.y+r.height,dist:0},t.snapElements.push(a))
n.start&&n.start(t,e)},PIXI.DragAndDropManager.prototype.onDragMove=function(){function t(t){return t*t}return function(e,n){var a,r,i=e.dragOptions,o=n.global.x,s=n.global.y,g=o-n.start.x,d=s-n.start.y,l=e.original.x+g-e.offset.x,p=e.original.y+d-e.offset.y,h=l+e.width,u=p+e.height
if(i.containment&&(a="parent"===i.containment?e.parent.getBounds():i.containment instanceof PIXI.Rectangle?i.containment:i.containment.getBounds(),"y"!==i.axis&&(0>l?l=0:h>a.width&&(l=a.width-e.width)),"x"!==i.axis&&(0>p?p=0:u>a.height&&(p=a.height-e.height))),i.grid){var m
i.grid[0]&&"y"!==i.axis&&(m=i.grid[0],l=e.original.x+Math.round((l-e.original.x)/m)*m,a&&!(l>0||h<a.width)&&(l+=l>0?-m:m)),i.grid[1]&&"x"!==i.axis&&(m=i.grid[1],p=e.original.y+Math.round((p-e.original.y)/m)*m,a&&!(p>0||u<a.height)&&(p+=p>0?-m:m))}if(i.snap){var c,D,y,I,f,r,M=!1,b=i.snapTolerance
if(i.snapSort){var x=e.worldTransform.tx+e.width/2,v=e.worldTransform.ty+e.height/2
for(r=e.snapElements.length-1;r>=0;r--)c=e.snapElements[r],c.snapBounds.dist=t(x-c.worldTransform.tx-c.width/2)+t(v-c.worldTransform.ty-c.height/2,2)
e.snapElements.sort(this.closestSort)}for(r=e.snapElements.length-1;!M&&r>=0;r--)c=e.snapElements[r],D=c.snapBounds.x,y=c.snapBounds.x2,I=c.snapBounds.y,f=c.snapBounds.y2,h>D-b&&y+b>l&&u>I-b&&f+b>p&&("inner"!==i.snapMode&&(Math.abs(I-u)<=b?(p=I-e.height,M=!0):Math.abs(f-p)<=b&&(p=f,M=!0),Math.abs(D-h)<=b?(l=D-e.width,M=!0):Math.abs(y-l)<=b&&(l=y,M=!0)),M||"outer"===i.snapMode||(Math.abs(I-p)<=b?(p=I,M=!0):Math.abs(f-u)<=b&&(p=f-e.height,M=!0),Math.abs(D-l)<=b?(l=D,M=!0):Math.abs(y-h)<=b&&(l=y-e.width,M=!0)))}"x"===i.axis?e.dragElement.x=l:"y"===i.axis?e.dragElement.y=p:(e.dragElement.x=l,e.dragElement.y=p),i.drag&&i.drag(e,n)}}(),PIXI.DragAndDropManager.prototype.onDrop=function(t,e){var n=t.dragOptions
t.dragElement.defaultCursor=t.dragElement._defaultCursor,t.dragElement.buttonMode=t.dragElement._buttonMode
var a=this.droppableItems,r=!1
if(a.length){var i,o,s,g,d=[],l=t.dragElement.getBounds()
for(l.x2=l.x+l.width,l.y2=l.y+l.height,s=a.length-1;s>=0;s--)if(i=a[s],i.worldVisible&&i!==t&&!i.dropOptions.disabled)if(o=i.dropOptions.accept,o instanceof Array){for(g=o.length-1;g>=0;g--)if((o[g]===this||o[g]===n.label)&&this.intersect(t,e,i,l)){if(r=!0,i.dropOptions.greedy){d.length=0,d.push(i),s=-1
break}d.push(i)}}else if((o===this||o===n.label||o===!0)&&this.intersect(t,e,i,l)){if(r=!0,i.dropOptions.greedy){d.length=0,d.push(i)
break}d.push(i)}for(s=d.length-1;s>=0;s--)d[s].dropOptions.drop&&d[s].dropOptions.drop(t,e)}else r=!0
"invalid"===n.revert&&!r||"valid"===n.revert&&r||n.revert===!0?n.revertDuration?(t.tweening=!0,this.tweeningItems.push({time:Date.now(),duration:n.revertDuration,item:t,mouse:e,x:t.dragElement.x,y:t.dragElement.y,dx:t.dragElement.x-t.original.x,dy:t.dragElement.y-t.original.y}),this.isTicking||(this.isTicking=!0,this.tick())):(t.dragElement.x=t.original.x,t.dragElement.y=t.original.y,this.stop(t,e)):(t.dragElement!==t&&(t.x=t.dragElement.x,t.y=t.dragElement.y),this.stop(t,e))},PIXI.DragAndDropManager.prototype.tick=function(){var t=this.tweeningItems.length
if(!t)return void(this.isTicking=!1)
requestAnimationFrame(this.boundTick)
for(var e,n,a,r=Date.now(),i=t-1;i>=0;i--)e=this.tweeningItems[i],n=r-e.time,a=e.item,n>=e.duration?(a.tweening=!1,a.dragElement.x=a.original.x,a.dragElement.y=a.original.y,this.stop(a,e.mouse),this.tweeningItems.splice(i,1)):(a.dragElement.x=e.x-e.dx*n/e.duration,a.dragElement.y=e.y-e.dy*n/e.duration)},PIXI.DragAndDropManager.prototype.stop=function(t,e){t.dragElement.alpha=t.originalAlpha,this.destroyHelperSprite(t),t.dragOptions.snap&&(t.snapElements.length=0),t.dragOptions.stop&&t.dragOptions.stop(t,e)},PIXI.DragAndDropManager.prototype.closestSort=function(t,e){return t.snapBounds.snapDist<e.snapBounds.snapDist?-1:t.snapBounds.snapDist>e.snapBounds.snapDist?1:0},PIXI.DragAndDropManager.prototype.destroyHelperSprite=function(t){t.dragElement&&t.dragElement!==t&&(t.dragElement.parent.removeChild(t.dragElement),t.dragElement.texture.destroy(!0),t.dragElement=null)},PIXI.DragAndDropManager.prototype.intersect=function(t,e,n,a){var r
switch(n.dropOptions.tolerance){case"intersect":return r=n.getBounds(),r.x<a.x+a.width/2&&a.x2-a.width/2<r.x+r.width&&r.y<a.y+a.height/2&&a.y2-a.height/2<r.y+r.height
case"fit":return r=n.getBounds(),r.x<=a.x&&a.x2<=r.x+r.width&&r.y<=a.y&&a.y2<=r.y+r.height
case"pointer":return t.stage.interactionManager.hitTest(n,e)
case"touch":return r=n.getBounds(),(a.y>=r.y&&a.y<=r.y+r.height||a.y2>=r.y&&a.y2<=r.y+r.height||a.y<r.y&&a.y2>r.y+r.height)&&(a.x>=r.x&&a.x<=r.x+r.width||a.x2>=r.x&&a.x2<=r.x+r.width||a.x<r.x&&a.x2>r.x+r.width)
default:return!1}},PIXI.DragAndDropManager.onMouseDown=function(t){this.dragOptions.mousedown&&this.dragOptions.mousedown(t),this.__isDragging=!0,this.stage.interactionManager.DragAndDropManager.onDrag(this,t)},PIXI.DragAndDropManager.onMouseMove=function(t){this.dragOptions.mousemove&&this.dragOptions.mousemove(t),this.__isDragging&&(this.__dragStart?this.stage.interactionManager.DragAndDropManager.onDragMove(this,t):(this.__dragStart=!0,this.stage.interactionManager.DragAndDropManager.onDragStart(this,t)))},PIXI.DragAndDropManager.onMouseUp=function(t){this.dragOptions.mouseup&&this.dragOptions.mouseup(t),this.__isDragging&&(this.__isDragging=!1,this.__dragStart&&(this.__dragStart=!1,this.stage.interactionManager.DragAndDropManager.onDrop(this,t)))},PIXI.DragAndDropManager.onMouseUpOutside=function(t){this.dragOptions.mouseupoutside&&this.dragOptions.mouseupoutside(t),this.__isDragging&&(this.__isDragging=!1,this.__dragStart&&(this.__dragStart=!1,this.stage.interactionManager.DragAndDropManager.onDrop(this,t)))},PIXI.DragAndDropManager.options={drag:{distance:1,axis:null,containment:null,cursor:"inherit",cursorAt:null,grid:!1,handle:null,cancel:null,helper:"original",alpha:1,revert:!1,revertDuration:500,label:null,snap:null,snapMode:"both",snapSort:!1,snapTolerance:20,disabled:!1,drag:null,start:null,stop:null,mousedown:null,mousemove:null,mouseup:null,mouseupoutside:null},drop:{label:null,drop:null,accept:!0,greedy:!1,disabled:!1,tolerance:"intersect"}},PIXI.InteractionManager.prototype.rebuildInteractiveGraph=function(){var t=PIXI.InteractionManager.prototype.rebuildInteractiveGraph
return function(){this.DragAndDropManager?this.DragAndDropManager.clear():this.DragAndDropManager=new PIXI.DragAndDropManager,t.call(this)
for(var e=this.interactiveItems.length-1;e>=0;e--)this.DragAndDropManager.collect(this.interactiveItems[e])}}();
